<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Comparativa: Compra vs. Aluguel (SAC)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --cor-fundo-principal: #1B4043;
            --cor-container: #225458;
            --cor-texto: #E0F2F1;
            --cor-label: #A0D9D5;
            --cor-input-bg: #143133;
            --cor-input-borda: #4D8B90;
            --cor-sombra: rgba(0, 0, 0, 0.3);

            /* Cores de destaque para o gráfico e conclusão */
            --cor-destaque-compra: #66FFC2;   /* Verde Menta Vibrante */
            --cor-destaque-aluguel: #00E5FF;  /* Ciano Elétrico */
            --cor-destaque-imovel: #F0F0F0;   /* Branco/Cinza Claro Elegante */
        }
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--cor-fundo-principal); color: var(--cor-texto);
            margin: 0; padding: 24px; display: flex; flex-direction: column; align-items: center;
            transition: background-color 0.3s ease;
        }
        .main-container { width: 100%; max-width: 1200px; }
        h1 { text-align: center; color: #fff; text-shadow: 1px 1px 3px var(--cor-sombra); font-size: 2.5rem; margin-bottom: 2rem; }
        h2 { border-bottom: 2px solid var(--cor-input-borda); padding-bottom: 10px; margin-top: 0; color: #fff; }
        .calculator-container, .results-container, .verdict-container, .chart-container, .table-container {
            background-color: var(--cor-container); padding: 30px; border-radius: 16px;
            box-shadow: 0 12px 30px var(--cor-sombra); margin-bottom: 30px;
        }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px 32px; }
        .input-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--cor-label); }
        input[type="text"] {
            padding: 12px 16px; border: 1px solid var(--cor-input-borda); border-radius: 8px;
            font-size: 16px; background-color: var(--cor-input-bg); color: var(--cor-texto); transition: all 0.2s ease-in-out;
        }
        input[type="text"]:focus {
            outline: none; border-color: var(--cor-destaque-compra); box-shadow: 0 0 0 3px rgba(102, 255, 194, 0.2);
        }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .result-item { background-color: var(--cor-input-bg); padding: 20px; border-radius: 8px; text-align: center; }
        .result-item .label { font-size: 14px; margin-bottom: 8px; color: var(--cor-label); }
        .result-item .value { font-size: 24px; font-weight: 700; }
        .result-item .value.compra { color: var(--cor-destaque-compra); }
        .result-item .value.aluguel { color: var(--cor-destaque-aluguel); }
        
        /* Estilos para o novo Bloco de Veredito */
        .verdict-container {
            text-align: center;
            border: 2px solid var(--cor-input-borda);
            transition: border-color 0.5s ease;
        }
        .verdict-title { border-bottom: none; }
        .verdict-text { font-size: 1.2rem; font-weight: 600; margin: 0; }
        .verdict-compra { border-color: var(--cor-destaque-compra); }
        .verdict-aluguel { border-color: var(--cor-destaque-aluguel); }

        .chart-container { position: relative; height: 500px; }
        .table-wrapper { max-height: 600px; overflow: auto; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: right; border-bottom: 1px solid var(--cor-input-borda); white-space: nowrap; }
        th { background-color: #143133; position: sticky; top: 0; font-weight: 600; }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>Calculadora Comparativa: Compra vs. Aluguel</h1>
        <div class="calculator-container">
            <h2>Parâmetros da Simulação</h2>
            <div class="grid-inputs">
                <div class="input-group"><label for="valorImovel">Valor do Imóvel (R$):</label><input type="text" class="formatar-milhar" id="valorImovel" value="2.000.000"></div>
                <div class="input-group"><label for="valorEntrada">Valor da Entrada (R$):</label><input type="text" class="formatar-milhar" id="valorEntrada" value="400.000"></div>
                <div class="input-group"><label for="numeroMeses">Prazo do Financiamento (Meses):</label><input type="text" class="formatar-milhar" id="numeroMeses" value="420"></div>
                <div class="input-group"><label for="taxaJuros">Taxa de Juros (a.a. %):</label><input type="text" id="taxaJuros" value="12"></div>
                <div class="input-group"><label for="trAnual">Taxa Referencial (TR) (a.a. %):</label><input type="text" id="trAnual" value="0.66"></div>
                <div class="input-group"><label for="itbi">ITBI (%):</label><input type="text" id="itbi" value="3"></div>
                <div class="input-group"><label for="corretagem">Corretagem (%):</label><input type="text" id="corretagem" value="3"></div>
                <div class="input-group"><label for="ipca">IPCA (a.a. %):</label><input type="text" id="ipca" value="5"></div>
                <div class="input-group"><label for="depreciacao">Depreciação (a.a. %):</label><input type="text" id="depreciacao" value="1"></div>
                <div class="input-group"><label for="taxaAluguelMensal">Taxa do Aluguel (% sobre Imóvel):</label><input type="text" id="taxaAluguelMensal" value="0.4"></div>
                <div class="input-group"><label for="taxaRetorno">Rentabilidade (a.a. %):</label><input type="text" id="taxaRetorno" value="11"></div>
                <div class="input-group"><label for="irAplicado">IR sobre Ganhos (%):</label><input type="text" id="irAplicado" value="15"></div>
            </div>
        </div>
        <div class="results-container">
            <h2>Resultados Finais</h2>
            <div class="results-grid">
                <div class="result-item"><label>Patrimônio Final (Compra)</label><div class="value compra" id="patrimonioCompra">R$ 0,00</div></div>
                <div class="result-item"><label>Patrimônio Final (Aluguel)</label><div class="value aluguel" id="patrimonioAluguel">R$ 0,00</div></div>
                <div class="result-item"><label>Custo do Financiamento (Σ Prestações)</label><div class="value" id="custoTotalFinanciamento">R$ 0,00</div></div>
            </div>
        </div>
        
        <div class="verdict-container" id="verdict-container">
            <h2 class="verdict-title">Qual a melhor opção?</h2>
            <p class="verdict-text" id="verdict-text">Aguardando cálculo para determinar o melhor cenário...</p>
        </div>

        <div class="chart-container">
            <h2>Evolução Patrimonial</h2>
            <canvas id="patrimonioChart"></canvas>
        </div>
        <div class="table-container" id="tabela-container"></div>
    </div>

    <script>
        let patrimonioChartInstance = null;
        
        const formatarMoeda = (valor) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        const formatarMilhar = (valor) => {
            if (!valor) return '';
            const numero = parseInt(String(valor).replace(/\D/g, ''), 10);
            return isNaN(numero) ? '' : new Intl.NumberFormat('pt-BR').format(numero);
        };

        const getValorMilhar = (id) => {
            const valorStr = document.getElementById(id).value || '0';
            return parseFloat(valorStr.replace(/\./g, '').replace(',', '.')) || 0;
        };
        const getValorDecimal = (id) => {
            const valorStr = document.getElementById(id).value || '0';
            return parseFloat(valorStr.replace(',', '.')) || 0;
        };
        
        const atualizarResultadosUI = (ultimoMes, custoTotal) => {
            document.getElementById('patrimonioCompra').textContent = formatarMoeda(ultimoMes?.patrimonioCompra || 0);
            document.getElementById('patrimonioAluguel').textContent = formatarMoeda(ultimoMes?.patrimonioAluguel || 0);
            document.getElementById('custoTotalFinanciamento').textContent = formatarMoeda(custoTotal || 0);
        };

        // Nova função para atualizar o bloco de veredito
        const atualizarVeredito = (ultimoMes) => {
            const container = document.getElementById('verdict-container');
            const texto = document.getElementById('verdict-text');
            
            if (!ultimoMes) {
                texto.textContent = 'Aguardando cálculo para determinar o melhor cenário...';
                container.className = 'verdict-container';
                return;
            }

            const pCompra = ultimoMes.patrimonioCompra;
            const pAluguel = ultimoMes.patrimonioAluguel;
            const diferenca = Math.abs(pCompra - pAluguel);

            if (pCompra > pAluguel) {
                texto.innerHTML = `Comprar foi a melhor opção, com um patrimônio <br><strong>${formatarMoeda(diferenca)}</strong> maior.`;
                container.className = 'verdict-container verdict-compra';
            } else if (pAluguel > pCompra) {
                texto.innerHTML = `Alugar foi a melhor opção, com um patrimônio <br><strong>${formatarMoeda(diferenca)}</strong> maior.`;
                container.className = 'verdict-container verdict-aluguel';
            } else {
                texto.textContent = 'Ambos os cenários resultaram em um patrimônio final equivalente.';
                container.className = 'verdict-container';
            }
        };

        const gerarTabela = (dados) => {
            const container = document.getElementById('tabela-container');
            let tableHTML = `<h2>Análise Detalhada Mês a Mês</h2><div class="table-wrapper"><table><thead><tr><th>Mês</th><th>Dívida Inicial</th><th>Correção (TR)</th><th>Dívida Corrigida</th><th>Juros</th><th>Amortização</th><th>Prestação</th><th>Saldo Devedor Final</th><th>Valor do Imóvel</th><th>Patrimônio (Compra)</th><th>Aluguel</th><th>Valor a Investir</th><th>Patrimônio (Aluguel)</th></tr></thead><tbody>`;
            dados.forEach(d => {
                tableHTML += `<tr><td>${d.mes}</td><td>${formatarMoeda(d.dividaInicial)}</td><td>${formatarMoeda(d.correcao)}</td><td>${formatarMoeda(d.dividaCorrigida)}</td><td>${formatarMoeda(d.juros)}</td><td>${formatarMoeda(d.amortizacao)}</td><td>${formatarMoeda(d.prestacao)}</td><td>${formatarMoeda(d.saldoDevedor)}</td><td>${formatarMoeda(d.valorImovelAtualizado)}</td><td>${formatarMoeda(d.patrimonioCompra)}</td><td>${formatarMoeda(d.aluguelAtual)}</td><td>${formatarMoeda(d.valorAInvestir)}</td><td>${formatarMoeda(d.patrimonioAluguel)}</td></tr>`;
            });
            tableHTML += '</tbody></table></div>';
            container.innerHTML = dados.length > 0 ? tableHTML : '';
        };

        const gerarGrafico = (dadosGrafico) => {
            const ctx = document.getElementById('patrimonioChart').getContext('2d');
            if (patrimonioChartInstance) patrimonioChartInstance.destroy();
            
            const styles = getComputedStyle(document.documentElement);

            patrimonioChartInstance = new Chart(ctx, {
                type: 'line', 
                data: {
                    labels: dadosGrafico.labels,
                    datasets: [
                        { 
                            label: 'Patrimônio (Compra)', 
                            data: dadosGrafico.patrimonioCompra, 
                            borderColor: styles.getPropertyValue('--cor-destaque-compra').trim(), 
                            backgroundColor: styles.getPropertyValue('--cor-destaque-compra').trim() + '1A', // Adiciona transparência
                            fill: true, 
                            tension: 0.2 
                        },
                        { 
                            label: 'Patrimônio (Aluguel)', 
                            data: dadosGrafico.patrimonioAluguel, 
                            borderColor: styles.getPropertyValue('--cor-destaque-aluguel').trim(),
                            backgroundColor: styles.getPropertyValue('--cor-destaque-aluguel').trim() + '1A',
                            fill: true, 
                            tension: 0.2 
                        },
                        { 
                            label: 'Valor do Imóvel', 
                            data: dadosGrafico.valorImovel, 
                            borderColor: styles.getPropertyValue('--cor-destaque-imovel').trim(),
                            borderWidth: 3,
                            borderDash: [5, 5], // Linha tracejada
                            fill: false, 
                            tension: 0.2,
                            pointRadius: 0
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            ticks: { 
                                callback: (value) => formatarMoeda(value).replace(/\,00$/, ''),
                                color: styles.getPropertyValue('--cor-label').trim()
                            },
                            grid: {
                                color: styles.getPropertyValue('--cor-input-borda').trim() + '80'
                            }
                        },
                        x: {
                            ticks: {
                                color: styles.getPropertyValue('--cor-label').trim()
                            },
                             grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: styles.getPropertyValue('--cor-texto').trim()
                            }
                        }
                    }
                }
            });
        };

        const calcular = () => {
            try {
                const params = {
                    valorImovel: getValorMilhar('valorImovel'), valorEntrada: getValorMilhar('valorEntrada'), numeroMeses: getValorMilhar('numeroMeses'),
                    taxaJurosAnual: getValorDecimal('taxaJuros') / 100, trAnual: getValorDecimal('trAnual') / 100, itbiPercent: getValorDecimal('itbi') / 100,
                    corretagemPercent: getValorDecimal('corretagem') / 100, ipcaAnual: getValorDecimal('ipca') / 100, depreciacaoAnual: getValorDecimal('depreciacao') / 100,
                    taxaAluguelMensal: getValorDecimal('taxaAluguelMensal') / 100, taxaRetornoAnual: getValorDecimal('taxaRetorno') / 100, irAplicadoPercent: getValorDecimal('irAplicado') / 100
                };
                const valorFinanciado = params.valorImovel - params.valorEntrada;
                if (params.numeroMeses <= 0 || valorFinanciado < 0) {
                    atualizarResultadosUI(null, null); atualizarVeredito(null); gerarTabela([]); gerarGrafico({ labels: [], datasets: [] }); return;
                }
                const custosIniciais = params.valorImovel * (params.itbiPercent + params.corretagemPercent);
                const taxaJurosMensal = Math.pow(1 + params.taxaJurosAnual, 1/12) - 1;
                const trMensal = Math.pow(1 + params.trAnual, 1/12) - 1;
                const taxaValorizacaoMensal = Math.pow(1 + params.ipcaAnual - params.depreciacaoAnual, 1/12) - 1;
                const taxaRetornoLiquidaAnual = params.taxaRetornoAnual * (1 - params.irAplicadoPercent);
                const taxaRetornoLiquidaMensal = Math.pow(1 + taxaRetornoLiquidaAnual, 1/12) - 1;
                
                let saldoDevedor = valorFinanciado, valorImovelAtualizado = params.valorImovel, aluguelAtual = params.valorImovel * params.taxaAluguelMensal;
                let patrimonioAluguel = params.valorEntrada + custosIniciais, custoTotalFinanciamento = 0;
                const dadosTabela = [];
                const dadosGrafico = { labels: [], patrimonioCompra: [], patrimonioAluguel: [], valorImovel: [] }; // Adicionado valorImovel
                
                for (let mes = 1; mes <= params.numeroMeses; mes++) {
                    const dividaInicial = saldoDevedor;
                    const correcao = dividaInicial * trMensal;
                    const dividaCorrigida = dividaInicial + correcao;

                    const mesesRestantes = params.numeroMeses - mes + 1;
                    const amortizacao = dividaCorrigida / mesesRestantes;
                    
                    const juros = dividaCorrigida * taxaJurosMensal;
                    let prestacao = amortizacao + juros;
                    saldoDevedor = dividaCorrigida - amortizacao;

                    if (mes === params.numeroMeses) {
                        if (saldoDevedor > 0.01) {
                            prestacao += saldoDevedor;
                        }
                        saldoDevedor = 0;
                    }

                    valorImovelAtualizado *= (1 + taxaValorizacaoMensal);
                    const patrimonioCompra = valorImovelAtualizado - saldoDevedor;
                    
                    const valorAInvestir = prestacao - aluguelAtual;
                    patrimonioAluguel = (patrimonioAluguel + valorAInvestir) * (1 + taxaRetornoLiquidaMensal);
                    
                    custoTotalFinanciamento += prestacao;

                    dadosTabela.push({ mes, dividaInicial, correcao, dividaCorrigida, juros, amortizacao, prestacao, saldoDevedor, valorImovelAtualizado, patrimonioCompra, aluguelAtual, valorAInvestir, patrimonioAluguel });
                    
                    if (mes % 12 === 0 && mes < params.numeroMeses) {
                        aluguelAtual *= (1 + params.ipcaAnual);
                    }

                    if (mes % 12 === 0 || mes === params.numeroMeses) {
                        dadosGrafico.labels.push(`Ano ${Math.ceil(mes / 12)}`);
                        dadosGrafico.patrimonioCompra.push(patrimonioCompra);
                        dadosGrafico.patrimonioAluguel.push(patrimonioAluguel);
                        dadosGrafico.valorImovel.push(valorImovelAtualizado); // Coletando dados do valor do imóvel
                    }
                }
                const ultimoMes = dadosTabela[dadosTabela.length - 1];
                atualizarResultadosUI(ultimoMes, custoTotalFinanciamento);
                atualizarVeredito(ultimoMes); // Chamando a nova função
                gerarTabela(dadosTabela);
                gerarGrafico(dadosGrafico);
            } catch (error) {
                console.error("ERRO NO CÁLCULO:", error);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('input[type="text"]');
            inputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    if (e.target.classList.contains('formatar-milhar')) {
                        const cursorPos = e.target.selectionStart;
                        const originalLength = e.target.value.length;
                        e.target.value = formatarMilhar(e.target.value);
                        const newLength = e.target.value.length;
                        if(cursorPos !== null) {
                           e.target.setSelectionRange(cursorPos + (newLength - originalLength), cursorPos + (newLength - originalLength));
                        }
                    }
                    calcular();
                });
                if (input.classList.contains('formatar-milhar')) {
                    input.value = formatarMilhar(input.value);
                }
            });
            calcular();
        });
    </script>
</body>
</html>

